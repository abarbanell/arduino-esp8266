---
title: Connecting ESP8266 to I2C sensors
category: iot
tags: iot, esp8266, arduino, i2c
---
	
_DRAFT: this is not complete yet._ 

In this post I want to show how to connect an ESP8266 to an I2C sensor. As example
I use the [NodeMCU](http://www.nodemcu.com/index_en.html) board from my latest 
[blog post](http://blog.abarbanell.de/arduino-esp8266/iot/lg/) and this sensor: 
[I2C Soil moisture sensor](https://www.tindie.com/products/miceuz/i2c-soil-moisture-sensor/)

# Wiring

The wiring is simple, I connected the 3.3V and GND from the NodeMCU to the respective points on 
the sensor and the SDA from the sensor to D2 on the nodeMCU, the SCL of the sensor to the D1
of the NodeMCU. Both need pullup resistors, but we can activate the builtin pullups in the 
NodeMCU via software later.

# Software

We will use the Wire library to implement the I2C protocol. Since the NodeMCU does not have any 
physical I2C pins, all are implemented in software in the Wire library. We just need to tell it 
which pins we use. 

Below is the Pin diagram of the NodeMCU and you can see that the pins D1 and D2 are mapped to the 
ESP8266 pins GPIO5 and GPIO4 (yes, in reverse order!) so we need to start the I2C with 

        wire.begin(4,5); // SDA on D2, SCL on D1

This also takes care of activating the PULLUP's for these two pins.

![esp8266 pins](https://raw.githubusercontent.com/nodemcu/nodemcu-devkit/master/Documents/NODEMCU-DEVKIT-INSTRUCTION-EN.png)


The full sketch is in my github repo 
[abarbanell/arduino-esp8266](https://github.com/abarbanell/arduino-esp8266/tree/master/sketch_lg_i2cscan)
as an extension of my previous [sketch_lg_heartbeat](https://github.com/abarbanell/arduino-esp8266/tree/master/sketch_lg_heartbeat), 
it is really quite simple, we configure the Wire library once in the setup() function and then run 
a loop through all valid I2C addresses every 5 minutes in the loop() function to count the connected 
devices. The details are printed on the Serial output, and the count is included in the heartbeat message 
we send back to our [Limitless Garden IOT backend](http://blog.abarbanell.de/raspberry/2015/12/30/monitoring-iot-backend).

The full code is at [abarbanell/arduino-esp8266](https://github.com/abarbanell/arduino-esp8266) in the sketch
[sketch_lg_i2cscan](https://github.com/abarbanell/arduino-esp8266/tree/master/sketch_lg_i2cscan).

Don't forget to change your config values in your own version of the config.h file as 
described in this 
[README](https://github.com/abarbanell/arduino-esp8266/blob/master/sketch_lg_heartbeat/README.md).


# Results so far

If all is well and your backend is up and running, you can see that a new 
collection "hb" (for heartbeat) has been created if it did not exist before: 

![lg collections]({{ site.baseurl }}/images/lg-collections.png)

and new rows will inculde the field i2cDevices field with a count of the connected 
devices: 

![lg hb collection]({{ site.baseurl }}/images/lg-hb-collection.png) 

# Sensor data

Now we have verified the connection it is time to read the actual sensor data and report it also 
back to the server.

*TODO* complete this section.

# Conclusion

In this short post I have shown how to connect a ESP8266 to an I2C device and send data to the 
Limitless Garden IOT backend. if you like it please give a star to this github repository
[abarbanell/esp8266](https://github.com/abarbanell/arduino-esp8266) or 
[abarbanell/limitless-garden](https://github.com/abarbanell/limitless-garden).

If you don't like it you may like my 
[Swiss Travel videos](https://www.youtube.com/playlist?list=PLyu5cHg7bWPiN-KlItY2fNfK20Gk_CE8b). 
Should this not be weird enough try 
[this video](https://www.youtube.com/watch?v=bLTNhu8izu0).

Also, feel free to comment below with any questions or suggestions.
