---
title: Sending Data from ESP8266 to my own IOT backend
category: iot
tags: iot, esp8266, arduino
---

# Sending Data to my "Limitless Garden" IOT backend	

We have set up our environment for ESP8266 development with the
Arduino IDE in a [previous
post](http://blog.abarbanell.de/arduino-esp8266/iot/setup/) and sent data
Matlab's [thingspeak](www.thingspeak.com) backend. Now it is
time to connect to our own IOT backend.

I have switched to a more convenient
[NodeMCU](http://www.nodemcu.com/index_en.html) board because it is
the simplest hardware setup I could find - no power supply, no separate 
flasher, just a simple usb plug from your development PC (in my case Ubuntu
Linux) to the ESP8266 board. The esp8266 can be plugged into a breadboard, 
but is a bit too wide for a normal size breadboard. I have just joined 
two half-size breadboards side-by-side and it looks like this: 

![esp8266 nodeMCU on breadboards]({{ site.baseurl }}/assets/img/2016/08/nodemcu-breadboard.jpg)

# Server side overview
A more detailed explanation of the "Limitless Garden" and how it
got its name is already online
[here](http://blog.abarbanell.de/raspberry/2015/12/30/monitoring-iot-backend).
The short story is that you can post any JSON data to any data collection with 
the call to 

```
POST <your limitless garden server>/api/collections/<your collection name>?user_key=<your API key>
```

My instance runs at https://lg.dokku.abarbanell.de and is protected with the 
following methods:

- encryption with https
- authetication for the website with Google ID (anybody can login and view data, 
but some update operations are only for privileged users)
- API is protected with a API_KEY from [3scale.com](www.3scale.com)

# Software

The full sketch is in my github repo 
[abarbanell/arduino-esp8266](https://github.com/abarbanell/arduino-esp8266/tree/master/sketch_lg_heartbeat)
and the sketch is called sketch_lg_heartbeat - it is really quite simple: after
pulling in the ESP8266WiFi library and my local configuration values (wireless 
SSID and password, backend server address and port) from config.h

        #include <ESP8266WiFi.h>
        #include "config.h"

it just calls the connectWiFi function from the sketch's setup(): 

        void connectWifi() {
        Serial.print("Connecting to ");
        Serial.println(WIFI_SSID);
            // temporary fix until SDK 1.5.4 is used
        WiFi.persistent(false);
        WiFi.mode(WIFI_OFF);
        WiFi.mode(WIFI_STA);
            // temporary fix end
        WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
        while (WiFi.status() != WL_CONNECTED) {
            delay(1000);
            Serial.print(WiFi.status());
            Serial.print(".");
        }
            Serial.println("");
            Serial.print("Connected with IP: "),
            Serial.println(WiFi.localIP());
        }

and then the sendData function from each loop(): 

        void sendData(String hostname, long uptime) {
            WiFiClient client;

            Serial.println("starting to sendData: " + hostname + ", " + String(uptime) + " to server: " + server);
            if (client.connect(server, port)) { 
                Serial.println("WiFi Client connected ");
            
                String postStr = "{ \"hostname\": \"";
                postStr += String(hostname);
                postStr += "\", \"uptime\": \"";
                postStr += String(uptime);
                postStr += "\" }";
            
                String url = "POST /api/collections/hb?user_key=";
                url += LG_API_KEY;
                url += " HTTP/1.1\n";
                url += "Host: ";
                url += LG_HOST;
                url += "\n";
                url += "Connection: close\n";
                url += "Content-Type: application/json\n";
                url += "Content-Length: ";
                url += String(postStr.length());
                url += "\n\n";
                
                Serial.print(url);
                Serial.print(postStr);client.print(url);
                client.print(postStr);
                delay(1000);
        
            } else {
                Serial.println("could not connect WifiClient");
            }
            client.stop();
        }

Most of the code is actually in the formatting of the JSON response, so it is
just a lot of details, but pretty easy if you know how your HTTP request and its 
headers and payload should look.

Don't forget to change your config values in your own version of the config.h file as 
described in the sketch's 
[README](https://github.com/abarbanell/arduino-esp8266/blob/master/sketch_lg_heartbeat/README.md).


# Results

If all is well and your backend is up and running, you can see that a new 
collection "hb" (for heartbeat) has been created: 

![lg collections]({{ site.baseurl }}/assets/img/2016/08/lg-collections.png)

and if you click on it you can see some data being recorded: 

![lg hb collection]({{ site.baseurl }}/assets/img/2016/08/lg-hb-collection.png) 

# Conclusion

In this short post I have shown how to connect a ESP8266 to send data to the 
Limitless Garden IOT backend. if you like it please give a star to this github repository
[abarbanell/esp8266](https://github.com/abarbanell/arduino-esp8266) or 
[abarbanell/limitless-garden](https://github.com/abarbanell/limitless-garden).

If you don't like it you may like my 
[Swiss Travel videos](https://www.youtube.com/playlist?list=PLyu5cHg7bWPiN-KlItY2fNfK20Gk_CE8b). 
Should this not be weird enough try 
[this video](https://www.youtube.com/watch?v=bLTNhu8izu0).

Also, feel free to comment below with any questions or suggestions.
